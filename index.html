<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Chore Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Google Sheets API configuration
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

    function App() {
      const [isAuthorized, setIsAuthorized] = useState(false);
      const [isInitialized, setIsInitialized] = useState(false);
      const [chores, setChores] = useState([]);
      const [todayChores, setTodayChores] = useState({ Jack: [], Mune: [] });
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [showWorkflows, setShowWorkflows] = useState(false);
      const [config, setConfig] = useState({
        apiKey: '',
        clientId: '',
        spreadsheetId: ''
      });

      // Load saved credentials on mount
      useEffect(() => {
        const savedConfig = localStorage.getItem('choreManagerConfig');
        if (savedConfig) {
          try {
            const parsed = JSON.parse(savedConfig);
            setConfig(parsed);
            console.log('Loaded saved credentials');
          } catch (err) {
            console.error('Failed to load saved config:', err);
          }
        }
      }, []);

      // Save credentials whenever they change
      useEffect(() => {
        if (config.apiKey || config.clientId || config.spreadsheetId) {
          localStorage.setItem('choreManagerConfig', JSON.stringify(config));
          console.log('Credentials saved');
        }
      }, [config]);

      // Initialize Google API
      useEffect(() => {
        const script = document.createElement('script');
        script.src = 'https://apis.google.com/js/api.js';
        script.onload = () => {
          gapi.load('client', () => {
            console.log('GAPI client loaded');
          });
        };
        document.body.appendChild(script);
      }, []);

      async function initializeGapiClient() {
        if (!config.apiKey) return;
        
        try {
          await gapi.client.init({
            apiKey: config.apiKey,
            discoveryDocs: [DISCOVERY_DOC],
          });
          setIsInitialized(true);
          console.log('GAPI initialized successfully');
        } catch (err) {
          setError('Failed to initialize: ' + err.message);
          console.error('GAPI init error:', err);
        }
      }

      // Initialize GAPI when config changes
      useEffect(() => {
        if (config.apiKey && typeof gapi !== 'undefined' && gapi.client) {
          initializeGapiClient();
        }
      }, [config.apiKey]);

      // Check if we have saved auth state
      useEffect(() => {
        const wasAuthorized = localStorage.getItem('choreManagerAuthorized');
        if (wasAuthorized === 'true' && config.apiKey && config.clientId && config.spreadsheetId) {
          // Don't set isAuthorized yet - wait for user to click connect
          // But we can show a message that credentials are ready
          console.log('Saved credentials found - ready to connect');
        }
      }, [config]);

      async function handleAuthClick() {
        if (!config.clientId) {
          setError('Please enter Client ID first');
          return;
        }

        if (!config.apiKey) {
          setError('Please enter API Key first');
          return;
        }

        // Make sure GAPI is initialized first
        if (!isInitialized) {
          setLoading(true);
          setError('Initializing Google API, please wait...');
          try {
            await initializeGapiClient();
            // Wait a moment for initialization to complete
            await new Promise(resolve => setTimeout(resolve, 1000));
          } catch (err) {
            setError('Failed to initialize API: ' + err.message);
            setLoading(false);
            return;
          }
          setLoading(false);
          setError(null);
        }

        try {
          const client = google.accounts.oauth2.initTokenClient({
            client_id: config.clientId,
            scope: SCOPES,
            callback: async (response) => {
              if (response.error) {
                setError('Authorization failed: ' + response.error);
                return;
              }
              setIsAuthorized(true);
              localStorage.setItem('choreManagerAuthorized', 'true');
              await loadChores();
            },
          });
          client.requestAccessToken();
        } catch (err) {
          setError('Authorization error: ' + err.message);
          console.error('Auth error:', err);
        }
      }

      async function loadChores() {
        if (!config.spreadsheetId) {
          setError('Please enter Spreadsheet ID');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: config.spreadsheetId,
            range: 'Sheet1!A:E',
          });

          const rows = response.result.values || [];
          if (rows.length === 0) {
            setError('No data found');
            return;
          }

          // Parse chores (skip header row)
          const parsedChores = rows.slice(1).map((row, idx) => ({
            id: idx,
            activity: row[0] || '',
            activityType: row[1] || '',
            startTime: row[2] || '',
            owner: row[3] || '',
            week: row[4] || ''
          }));

          setChores(parsedChores);
          filterTodayChores(parsedChores);
        } catch (err) {
          setError('Failed to load chores: ' + err.message);
        } finally {
          setLoading(false);
        }
      }

      function filterTodayChores(allChores) {
        const dateToCheck = selectedDate;
        const dateStr = `${dateToCheck.getMonth() + 1}/${dateToCheck.getDate()}/${dateToCheck.getFullYear()}`;
        
        const jackChores = allChores.filter(c => 
          c.startTime === dateStr && c.owner === 'Jack'
        );
        const muneChores = allChores.filter(c => 
          c.startTime === dateStr && c.owner === 'Mune'
        );

        setTodayChores({ Jack: jackChores, Mune: muneChores });
      }

      // Re-filter when selected date changes
      useEffect(() => {
        if (chores.length > 0) {
          filterTodayChores(chores);
        }
      }, [selectedDate]);

      async function extendPattern() {
        if (!config.spreadsheetId || chores.length === 0) {
          setError('Load chores first');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          // Find the last entry
          const lastChore = chores[chores.length - 1];
          const lastDate = new Date(lastChore.startTime);
          const lastWeek = parseInt(lastChore.week.replace('Week ', ''));

          // Determine custody pattern starting point
          const newRows = [];
          let currentDate = new Date(lastDate);
          currentDate.setDate(currentDate.getDate() + 1);
          
          // Generate 8 weeks (56 days of custody pattern)
          const choreTypes = [
            { activity: 'Feed Yuna', type: 'Daily' },
            { activity: 'Feed Cats', type: 'Daily' },
            { activity: 'Laundry', type: 'Weekly' },
            { activity: 'Vacuum Upstairs', type: 'Weekly' },
            { activity: 'Vacuum Downstairs', type: 'Weekly' },
            { activity: 'Wipe Down Kitchen Table and Doorknobs', type: 'Weekly' },
            { activity: 'Walk Dog', type: 'Biweekly' },
            { activity: 'Empty Upstairs Trashcans', type: 'Biweekly' },
            { activity: 'Dusting', type: 'Biweekly' },
            { activity: 'Wipe Down Creep Windows', type: 'Biweekly' },
            { activity: 'Clean Toilets', type: 'Monthly' },
            { activity: 'Change Hand Towels', type: 'Weekly' }
          ];

          // This is a simplified version - you'll need to customize based on your exact rotation logic
          let weekNum = lastWeek;
          let dayCount = 0;
          const owners = ['Jack', 'Mune'];
          let ownerIdx = 0;

          for (let i = 0; i < 112; i++) { // 8 weeks worth of days
            // Check if this day is a custody day (5/2/2/5 pattern)
            const cycleDay = i % 14;
            const isCustodyDay = (cycleDay < 5) || (cycleDay >= 7 && cycleDay < 9);

            if (!isCustodyDay) continue;

            dayCount++;
            if (dayCount > 7) {
              dayCount = 1;
              weekNum = (weekNum % 8) + 1;
            }

            const dateStr = `${currentDate.getMonth() + 1}/${currentDate.getDate()}/${currentDate.getFullYear()}`;

            // Add daily chores
            choreTypes.filter(c => c.type === 'Daily').forEach(chore => {
              newRows.push([
                chore.activity,
                chore.type,
                dateStr,
                owners[ownerIdx % 2],
                `Week ${weekNum}`
              ]);
            });

            // Add weekly chores (once per week)
            if (dayCount === 1) {
              choreTypes.filter(c => c.type === 'Weekly').forEach(chore => {
                newRows.push([
                  chore.activity,
                  chore.type,
                  dateStr,
                  owners[ownerIdx % 2],
                  `Week ${weekNum}`
                ]);
              });
            }

            ownerIdx++;
            currentDate.setDate(currentDate.getDate() + 1);
          }

          // Append to sheet
          await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: config.spreadsheetId,
            range: 'Sheet1!A:E',
            valueInputOption: 'RAW',
            resource: {
              values: newRows
            }
          });

          alert('Pattern extended successfully! Reload to see changes.');
          loadChores();
        } catch (err) {
          setError('Failed to extend pattern: ' + err.message);
        } finally {
          setLoading(false);
        }
      }

      async function skipDates() {
        const startDate = prompt('Skip from (MM/DD/YYYY):');
        const endDate = prompt('Skip to (MM/DD/YYYY):');
        
        if (!startDate || !endDate) return;

        alert('Skip & Continue: This will remove entries between those dates and continue the rotation from where it left off.');
        // Implementation would delete rows and continue pattern
      }

      async function pauseResume() {
        const pauseDate = prompt('Pause from (MM/DD/YYYY):');
        const resumeDate = prompt('Resume on (MM/DD/YYYY):');
        
        if (!pauseDate || !resumeDate) return;

        alert('Pause & Resume: This will pause the 8-week cycle and resume it at the same point later.');
        // Implementation would track cycle position and resume
      }

      if (!isAuthorized) {
        const hasCredentials = config.apiKey && config.clientId && config.spreadsheetId;
        
        return (
          <div style={styles.container}>
            <div style={styles.setupCard}>
              <h1 style={styles.title}>üè† Chore Manager</h1>
              <p style={styles.subtitle}>
                {hasCredentials ? 'Ready to connect!' : 'Connect to your Google Sheet'}
              </p>
              
              {hasCredentials && (
                <p style={styles.savedMessage}>
                  ‚úì Your credentials are saved. Click below to connect.
                </p>
              )}

              <div style={styles.inputGroup}>
                <label style={styles.label}>Google API Key</label>
                <input
                  type="text"
                  style={styles.input}
                  placeholder="AIza..."
                  value={config.apiKey}
                  onChange={(e) => setConfig({...config, apiKey: e.target.value})}
                />
              </div>

              <div style={styles.inputGroup}>
                <label style={styles.label}>Google Client ID</label>
                <input
                  type="text"
                  style={styles.input}
                  placeholder="xxx.apps.googleusercontent.com"
                  value={config.clientId}
                  onChange={(e) => setConfig({...config, clientId: e.target.value})}
                />
              </div>

              <div style={styles.inputGroup}>
                <label style={styles.label}>Spreadsheet ID</label>
                <input
                  type="text"
                  style={styles.input}
                  placeholder="1a2b3c..."
                  value={config.spreadsheetId}
                  onChange={(e) => setConfig({...config, spreadsheetId: e.target.value})}
                />
              </div>

              <button 
                style={{
                  ...styles.primaryButton,
                  opacity: (!isInitialized && config.apiKey) ? 0.5 : 1,
                  cursor: (!isInitialized && config.apiKey) ? 'not-allowed' : 'pointer'
                }}
                onClick={handleAuthClick}
                disabled={!isInitialized && config.apiKey}
              >
                {!isInitialized && config.apiKey ? 'Initializing...' : 'Connect to Google Sheets'}
              </button>

              {error && <p style={styles.error}>{error}</p>}

              {!hasCredentials && (
                <div style={styles.instructions}>
                  <p style={styles.instructionTitle}>Setup Instructions:</p>
                  <ol style={styles.instructionList}>
                    <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                    <li>Create a new project</li>
                    <li>Enable Google Sheets API</li>
                    <li>Create credentials (API Key & OAuth 2.0 Client ID)</li>
                    <li>Copy your Spreadsheet ID from the URL</li>
                  </ol>
                </div>
              )}
            </div>
          </div>
        );
      }

      return (
        <div style={styles.container}>
          <div style={styles.header}>
            <h1 style={styles.appTitle}>Chore Manager</h1>
            <button 
              style={styles.workflowButton}
              onClick={() => setShowWorkflows(!showWorkflows)}
            >
              {showWorkflows ? 'üìã View Chores' : '‚öôÔ∏è Workflows'}
            </button>
          </div>

          {!showWorkflows && (
            <div style={styles.datePickerSection}>
              <button 
                style={styles.dateNavButton}
                onClick={() => {
                  const newDate = new Date(selectedDate);
                  newDate.setDate(newDate.getDate() - 1);
                  setSelectedDate(newDate);
                }}
              >
                ‚Äπ
              </button>
              
              <div style={styles.datePicker}>
                <input
                  type="date"
                  style={styles.dateInput}
                  value={selectedDate.toISOString().split('T')[0]}
                  onChange={(e) => setSelectedDate(new Date(e.target.value + 'T00:00:00'))}
                />
                <button
                  style={styles.todayButton}
                  onClick={() => setSelectedDate(new Date())}
                >
                  Today
                </button>
              </div>

              <button 
                style={styles.dateNavButton}
                onClick={() => {
                  const newDate = new Date(selectedDate);
                  newDate.setDate(newDate.getDate() + 1);
                  setSelectedDate(newDate);
                }}
              >
                ‚Ä∫
              </button>
            </div>
          )}

          {loading && <p style={styles.loading}>Loading...</p>}
          {error && <p style={styles.error}>{error}</p>}

          {!showWorkflows ? (
            <div style={styles.choreGrid}>
              <div style={styles.choreCard}>
                <div style={styles.choreCardHeader}>
                  <h2 style={styles.kidName}>Jack</h2>
                  <span style={styles.dateLabel}>
                    {selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                  </span>
                </div>
                {todayChores.Jack.length === 0 ? (
                  <p style={styles.noChores}>No chores today! üéâ</p>
                ) : (
                  <ul style={styles.choreList}>
                    {todayChores.Jack.map(chore => (
                      <li key={chore.id} style={styles.choreItem}>
                        <span style={styles.choreActivity}>{chore.activity}</span>
                        <span style={styles.choreType}>{chore.activityType}</span>
                      </li>
                    ))}
                  </ul>
                )}
              </div>

              <div style={styles.choreCard}>
                <div style={styles.choreCardHeader}>
                  <h2 style={styles.kidName}>Mune</h2>
                  <span style={styles.dateLabel}>
                    {selectedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                  </span>
                </div>
                {todayChores.Mune.length === 0 ? (
                  <p style={styles.noChores}>No chores today! üéâ</p>
                ) : (
                  <ul style={styles.choreList}>
                    {todayChores.Mune.map(chore => (
                      <li key={chore.id} style={styles.choreItem}>
                        <span style={styles.choreActivity}>{chore.activity}</span>
                        <span style={styles.choreType}>{chore.activityType}</span>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </div>
          ) : (
            <div style={styles.workflowPanel}>
              <h2 style={styles.workflowTitle}>Workflow Tools</h2>
              
              <button 
                style={styles.workflowActionButton}
                onClick={extendPattern}
              >
                üìÖ Extend Pattern (8 Weeks)
              </button>

              <button 
                style={styles.workflowActionButton}
                onClick={skipDates}
              >
                ‚è≠Ô∏è Skip Dates (Continue Rotation)
              </button>

              <button 
                style={styles.workflowActionButton}
                onClick={pauseResume}
              >
                ‚è∏Ô∏è Pause & Resume Cycle
              </button>

              <button 
                style={styles.secondaryButton}
                onClick={loadChores}
              >
                üîÑ Reload Chores
              </button>
            </div>
          )}

          <div style={styles.footer}>
            <p style={styles.footerText}>Last updated: {new Date().toLocaleDateString()}</p>
          </div>
        </div>
      );
    }

    const styles = {
      container: {
        minHeight: '100vh',
        background: 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)',
        padding: '20px',
        fontFamily: "'DM Sans', sans-serif",
      },
      setupCard: {
        background: 'white',
        borderRadius: '24px',
        padding: '32px',
        maxWidth: '500px',
        margin: '40px auto',
        boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
      },
      title: {
        fontSize: '32px',
        fontWeight: '700',
        color: '#1a1a1a',
        margin: '0 0 8px 0',
        textAlign: 'center',
      },
      subtitle: {
        fontSize: '16px',
        color: '#666',
        margin: '0 0 32px 0',
        textAlign: 'center',
      },
      savedMessage: {
        fontSize: '14px',
        fontWeight: '500',
        color: '#27ae60',
        background: '#e8f5e9',
        padding: '12px 16px',
        borderRadius: '12px',
        textAlign: 'center',
        marginBottom: '24px',
      },
      inputGroup: {
        marginBottom: '20px',
      },
      label: {
        display: 'block',
        fontSize: '14px',
        fontWeight: '500',
        color: '#333',
        marginBottom: '8px',
      },
      input: {
        width: '100%',
        padding: '12px 16px',
        fontSize: '14px',
        border: '2px solid #e0e0e0',
        borderRadius: '12px',
        outline: 'none',
        transition: 'border-color 0.2s',
        boxSizing: 'border-box',
      },
      primaryButton: {
        width: '100%',
        padding: '16px',
        fontSize: '16px',
        fontWeight: '600',
        color: 'white',
        background: 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)',
        border: 'none',
        borderRadius: '12px',
        cursor: 'pointer',
        marginTop: '24px',
      },
      instructions: {
        marginTop: '32px',
        padding: '20px',
        background: '#f8f9fa',
        borderRadius: '12px',
      },
      instructionTitle: {
        fontSize: '14px',
        fontWeight: '600',
        color: '#333',
        margin: '0 0 12px 0',
      },
      instructionList: {
        margin: '0',
        paddingLeft: '20px',
        fontSize: '13px',
        color: '#666',
        lineHeight: '1.8',
      },
      header: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '24px',
        padding: '0 8px',
      },
      appTitle: {
        fontSize: '28px',
        fontWeight: '700',
        color: 'white',
        margin: 0,
        textShadow: '0 2px 8px rgba(0,0,0,0.2)',
      },
      workflowButton: {
        padding: '10px 16px',
        fontSize: '14px',
        fontWeight: '500',
        color: 'white',
        background: 'rgba(255,255,255,0.2)',
        border: '2px solid rgba(255,255,255,0.3)',
        borderRadius: '12px',
        cursor: 'pointer',
        backdropFilter: 'blur(10px)',
      },
      datePickerSection: {
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '12px',
        marginBottom: '24px',
        padding: '0 8px',
      },
      dateNavButton: {
        width: '48px',
        height: '48px',
        fontSize: '24px',
        fontWeight: '700',
        color: 'white',
        background: 'rgba(255,255,255,0.2)',
        border: '2px solid rgba(255,255,255,0.3)',
        borderRadius: '12px',
        cursor: 'pointer',
        backdropFilter: 'blur(10px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
      },
      datePicker: {
        display: 'flex',
        gap: '8px',
        alignItems: 'center',
      },
      dateInput: {
        padding: '12px 16px',
        fontSize: '14px',
        fontWeight: '500',
        color: '#2c3e50',
        background: 'white',
        border: '2px solid rgba(255,255,255,0.3)',
        borderRadius: '12px',
        outline: 'none',
      },
      todayButton: {
        padding: '12px 20px',
        fontSize: '14px',
        fontWeight: '600',
        color: 'white',
        background: 'rgba(255,255,255,0.2)',
        border: '2px solid rgba(255,255,255,0.3)',
        borderRadius: '12px',
        cursor: 'pointer',
        backdropFilter: 'blur(10px)',
      },
      choreGrid: {
        display: 'grid',
        gridTemplateColumns: '1fr',
        gap: '20px',
        marginBottom: '24px',
      },
      choreCard: {
        background: 'white',
        borderRadius: '20px',
        padding: '24px',
        boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
      },
      choreCardHeader: {
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: '16px',
      },
      kidName: {
        fontSize: '24px',
        fontWeight: '700',
        color: '#2c3e50',
        margin: '0',
      },
      dateLabel: {
        fontSize: '13px',
        fontWeight: '500',
        color: '#95a5a6',
        fontFamily: "'Space Mono', monospace",
      },
      noChores: {
        fontSize: '16px',
        color: '#999',
        fontStyle: 'italic',
      },
      choreList: {
        listStyle: 'none',
        padding: 0,
        margin: 0,
      },
      choreItem: {
        padding: '12px 0',
        borderBottom: '1px solid #f0f0f0',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
      },
      choreActivity: {
        fontSize: '16px',
        color: '#333',
        fontWeight: '500',
      },
      choreType: {
        fontSize: '12px',
        color: '#999',
        fontFamily: "'Space Mono', monospace",
        textTransform: 'uppercase',
        letterSpacing: '0.5px',
      },
      workflowPanel: {
        background: 'white',
        borderRadius: '20px',
        padding: '32px',
        boxShadow: '0 10px 30px rgba(0,0,0,0.2)',
      },
      workflowTitle: {
        fontSize: '24px',
        fontWeight: '700',
        color: '#333',
        margin: '0 0 24px 0',
      },
      workflowActionButton: {
        width: '100%',
        padding: '16px',
        fontSize: '16px',
        fontWeight: '600',
        color: '#2c3e50',
        background: 'white',
        border: '2px solid #2c3e50',
        borderRadius: '12px',
        cursor: 'pointer',
        marginBottom: '12px',
        transition: 'all 0.2s',
      },
      secondaryButton: {
        width: '100%',
        padding: '16px',
        fontSize: '16px',
        fontWeight: '600',
        color: '#999',
        background: '#f8f9fa',
        border: 'none',
        borderRadius: '12px',
        cursor: 'pointer',
        marginTop: '12px',
      },
      loading: {
        textAlign: 'center',
        color: 'white',
        fontSize: '16px',
        padding: '20px',
      },
      error: {
        color: '#ff6b6b',
        background: 'white',
        padding: '12px 16px',
        borderRadius: '12px',
        fontSize: '14px',
        margin: '12px 0',
        textAlign: 'center',
      },
      footer: {
        textAlign: 'center',
        marginTop: '32px',
      },
      footerText: {
        color: 'rgba(255,255,255,0.8)',
        fontSize: '13px',
        margin: 0,
      },
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
